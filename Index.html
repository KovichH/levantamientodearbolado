<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Levantamiento Inventario de Arbolado</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #map {
            flex-grow: 1;
            width: 100%;
            height: 85vh;
            position: relative;
        }
        #controls {
            display: flex;
            padding: 10px;
            background-color: #f0f0f0;
            gap: 10px;
        }
        #locationBtn {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        #locationBtn .material-icons {
            margin-right: 5px;
        }
        #treeList {
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #ddd;
            padding: 10px;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
        }
        .modal-content input, 
        .modal-content textarea,
        .modal-content select {
            width: 100%;
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .modal-content label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .button-group button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #saveTreeBtn {
            background-color: #4CAF50;
            color: white;
        }
        #cancelBtn {
            background-color: #f44336;
            color: white;
        }
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 1100;
        }
        #mapCoordinates {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: white;
            padding: 5px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button id="addTreeBtn">A√±adir √Årbol</button>
        <button id="exportBtn">Exportar Datos</button>
        <button id="locationBtn">
            <span class="material-icons">my_location</span>
            Centrar Ubicaci√≥n
        </button>
    </div>
    <div id="map"></div>
    <div id="mapCoordinates">Lat: - | Lng: -</div>
    <div id="treeList"></div>
    <div id="toast"></div>

    <!-- Librer√≠as externas -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <script>
        // Base de datos local
        class TreeDatabase {
            constructor() {
                this.trees = JSON.parse(localStorage.getItem('levantamiento_arbolado') || '[]');
                this.cleanExpiredTrees();
            }

            cleanExpiredTrees() {
                const now = new Date();
                const eightHoursAgo = new Date(now.getTime() - 8 * 60 * 60 * 1000);
                
                this.trees = this.trees.filter(tree => {
                    const treeDate = new Date(tree.timestamp);
                    return treeDate > eightHoursAgo;
                });

                this.save();
            }

            addTree(treeData) {
                const newTree = {
                    ...treeData,
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString()
                };
                this.trees.push(newTree);
                this.save();
                return newTree;
            }

            getAllTrees() {
                return this.trees;
            }

            save() {
                localStorage.setItem('levantamiento_arbolado', JSON.stringify(this.trees));
            }

            exportToCSV() {
                return Papa.unparse(this.trees);
            }
        }

        // Inicializaci√≥n de componentes
        class TreeInventoryApp {
            constructor() {
                this.db = new TreeDatabase();
                this.map = null;
                this.markers = [];
                this.currentLocation = null;

                this.initMap();
                this.bindEvents();
                this.renderTreeList();
            }

            initMap() {
                // Inicializar mapa (ubicaci√≥n por defecto Ciudad de M√©xico)
                this.map = L.map('map').setView([19.4326, -99.1332], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(this.map);

                // A√±adir marcadores existentes
                this.db.getAllTrees().forEach(tree => this.addMarker(tree));

                // Evento de movimiento del mapa para mostrar coordenadas
                this.map.on('move', () => {
                    const center = this.map.getCenter();
                    document.getElementById('mapCoordinates').textContent = 
                        `Lat: ${center.lat.toFixed(5)} | Lng: ${center.lng.toFixed(5)}`;
                });
            }

            bindEvents() {
                document.getElementById('addTreeBtn').addEventListener('click', () => this.showAddTreeModal());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportData());
                document.getElementById('locationBtn').addEventListener('click', () => this.centerLocation());
            }

            centerLocation() {
                // Verificar si estamos en un contexto seguro
                if (location.protocol === 'file:') {
                    this.showToast('‚ö†Ô∏è Para usar geolocalizaci√≥n, abra el archivo en un servidor web (HTTPS)');
                    return;
                }

                if ("geolocation" in navigator) {
                    // Mostrar mensaje de carga
                    this.showToast('üìç Obteniendo ubicaci√≥n...');
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            // Centrar mapa en la ubicaci√≥n
                            this.map.setView([lat, lng], 15);
                            
                            // Crear un marcador temporal
                            const marker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    className: 'location-marker',
                                    html: `<div style="background-color: #007bff; width: 15px; height: 15px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,123,255,0.5);"></div>`
                                })
                            }).addTo(this.map);

                            // Quitar marcador despu√©s de 5 segundos
                            setTimeout(() => {
                                this.map.removeLayer(marker);
                            }, 5000);

                            this.showToast('‚úÖ Ubicaci√≥n centrada correctamente');
                        },
                        (error) => {
                            let errorMessage = '‚ùå Error de geolocalizaci√≥n: ';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage += 'Permiso denegado. Active la ubicaci√≥n en su navegador.';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage += 'Ubicaci√≥n no disponible.';
                                    break;
                                case error.TIMEOUT:
                                    errorMessage += 'Tiempo de espera agotado.';
                                    break;
                                default:
                                    errorMessage += 'Error desconocido.';
                                    break;
                            }
                            this.showToast(errorMessage);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000 // 5 minutos
                        }
                    );
                } else {
                    this.showToast('‚ùå Geolocalizaci√≥n no soportada en este navegador');
                }
            }

            showAddTreeModal() {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h2>Registrar √Årbol</h2>
                        <label>Latitud:
                            <input type="number" id="latInput" step="any" required>
                        </label>
                        <label>Longitud:
                            <input type="number" id="lngInput" step="any" required>
                        </label>
                        <label>Especie:
                            <input type="text" id="treeSpecies" placeholder="Nombre de la especie" required>
                        </label>
                        <label>Espacio disponible para √°rboles:
                            <input type="number" id="availableSpace" min="0" placeholder="N√∫mero de espacios disponibles">
                        </label>
                        <label>Cantidad de √Årboles:
                            <input type="number" id="treeCount" min="1" value="1" required>
                        </label>
                        <label>Porte de √°rboles (opcional):
                            <select id="treeSize">
                                <option value="">Seleccione el porte</option>
                                <option value="chico">Chico</option>
                                <option value="mediano">Mediano</option>
                                <option value="grande">Grande</option>
                                <option value="chico-mediano">Chico y Mediano</option>
                                <option value="chico-grande">Chico y Grande</option>
                                <option value="mediano-grande">Mediano y Grande</option>
                            </select>
                        </label>
                        <label>Notas adicionales (opcional):
                            <textarea id="treeNotes" rows="3" placeholder="Descripci√≥n o caracter√≠sticas"></textarea>
                        </label>
                        <div class="button-group">
                            <button id="saveTreeBtn">Guardar</button>
                            <button id="cancelBtn">Cancelar</button>
                        </div>
                        <p><small>Puedes obtener las coordenadas moviendo el mapa</small></p>
                    </div>
                `;

                document.body.appendChild(modal);

                // Hacer clic fuera del modal para cerrarlo
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });

                // Obtener coordenadas actuales del centro del mapa
                const center = this.map.getCenter();
                document.getElementById('latInput').value = center.lat.toFixed(5);
                document.getElementById('lngInput').value = center.lng.toFixed(5);

                document.getElementById('saveTreeBtn').addEventListener('click', () => {
                    const lat = parseFloat(document.getElementById('latInput').value);
                    const lng = parseFloat(document.getElementById('lngInput').value);
                    const species = document.getElementById('treeSpecies').value.trim();
                    const availableSpace = document.getElementById('availableSpace').value;
                    const count = parseInt(document.getElementById('treeCount').value);
                    const size = document.getElementById('treeSize').value;
                    const notes = document.getElementById('treeNotes').value;

                    // Validaciones b√°sicas
                    if (isNaN(lat) || isNaN(lng)) {
                        this.showToast('Coordenadas inv√°lidas');
                        return;
                    }

                    if (!species) {
                        this.showToast('Debe ingresar una especie');
                        return;
                    }

                    if (isNaN(count) || count < 1) {
                        this.showToast('La cantidad debe ser un n√∫mero mayor a 0');
                        return;
                    }

                    const newTree = this.db.addTree({
                        lat: lat,
                        lng: lng,
                        especie: species,
                        espacioDisponible: availableSpace ? parseInt(availableSpace) : null,
                        cantidad: count,
                        porte: size || null,
                        notas: notes,
                        precision: null
                    });

                    this.addMarker(newTree);
                    this.renderTreeList();
                    this.showToast('√Årbol registrado exitosamente');
                    document.body.removeChild(modal);
                });

                document.getElementById('cancelBtn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            }

            addMarker(tree) {
                // Definir color seg√∫n el porte
                let markerColor = 'green';
                if (tree.porte) {
                    if (tree.porte === 'chico') markerColor = '#90EE90';
                    else if (tree.porte === 'mediano') markerColor = '#228B22';
                    else if (tree.porte === 'grande') markerColor = '#006400';
                    else if (tree.porte === 'chico-mediano') markerColor = '#7FFF00';
                    else if (tree.porte === 'chico-grande') markerColor = '#32CD32';
                    else if (tree.porte === 'mediano-grande') markerColor = '#008B00';
                }

                const marker = L.marker([tree.lat, tree.lng], {
                    icon: L.divIcon({
                        className: 'tree-marker',
                        html: `<div style="background-color: ${markerColor}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.3);"></div>`
                    })
                }).addTo(this.map);

                // A√±adir popup con informaci√≥n del √°rbol
                let popupContent = `<b>Especie:</b> ${tree.especie}<br>`;
                if (tree.espacioDisponible !== null && tree.espacioDisponible !== undefined) {
                    popupContent += `<b>Espacio disponible:</b> ${tree.espacioDisponible}<br>`;
                }
                popupContent += `<b>Cantidad:</b> ${tree.cantidad}<br>`;
                if (tree.porte) {
                    popupContent += `<b>Porte:</b> ${tree.porte}<br>`;
                }
                if (tree.notas) {
                    popupContent += `<b>Notas:</b> ${tree.notas}<br>`;
                }
                popupContent += `<small><b>Coordenadas:</b> ${tree.lat.toFixed(5)}, ${tree.lng.toFixed(5)}</small>`;

                marker.bindPopup(popupContent);

                this.markers.push(marker);
            }

            renderTreeList() {
                const treeList = document.getElementById('treeList');
                treeList.innerHTML = '<h3>√Årboles Registrados:</h3>';

                const trees = this.db.getAllTrees();
                if (trees.length === 0) {
                    treeList.innerHTML += '<p>No hay √°rboles registrados</p>';
                    return;
                }

                trees.forEach(tree => {
                    const treeItem = document.createElement('div');
                    treeItem.style.marginBottom = '5px';
                    treeItem.style.padding = '5px';
                    
                    // Color de la barra lateral seg√∫n el porte (si existe)
                    let borderColor = '#cccccc';
                    if (tree.porte) {
                        if (tree.porte === 'chico') borderColor = '#90EE90';
                        else if (tree.porte === 'mediano') borderColor = '#228B22';
                        else if (tree.porte === 'grande') borderColor = '#006400';
                        else if (tree.porte === 'chico-mediano') borderColor = '#7FFF00';
                        else if (tree.porte === 'chico-grande') borderColor = '#32CD32';
                        else if (tree.porte === 'mediano-grande') borderColor = '#008B00';
                    }
                    
                    treeItem.style.borderLeft = `4px solid ${borderColor}`;
                    
                    let itemContent = `<strong>${tree.especie}</strong> - ${tree.cantidad} √°rbol${tree.cantidad > 1 ? 'es' : ''}`;
                    if (tree.porte) {
                        itemContent += ` (${tree.porte})`;
                    }
                    if (tree.espacioDisponible !== null && tree.espacioDisponible !== undefined) {
                        itemContent += `<br><small>Espacio disponible: ${tree.espacioDisponible}</small>`;
                    }
                    itemContent += `<br><small>Lat: ${tree.lat.toFixed(4)}, Lng: ${tree.lng.toFixed(4)}</small>`;
                    
                    treeItem.innerHTML = itemContent;
                    treeList.appendChild(treeItem);
                });
            }

            exportData() {
                const trees = this.db.getAllTrees();
                if (trees.length === 0) {
                    this.showToast('No hay datos para exportar');
                    return;
                }

                const csvContent = this.db.exportToCSV();
                
                // Crear un blob para descargar
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                
                // Nombre del archivo con fecha y hora
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
                link.setAttribute("download", `levantamiento_arbolado_${timestamp}.csv`);
                
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                this.showToast(`Datos exportados: ${trees.length} registro${trees.length > 1 ? 's' : ''}`);
            }

            showToast(message) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.style.display = 'block';
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }
        }

        // Iniciar aplicaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            new TreeInventoryApp();
        });
    </script>
</body>
</html>